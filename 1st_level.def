BootStrap: docker
From: ubuntu:20.04

%post
    # Update and install basic dependencies
    apt-get update && apt-get install -y \
        wget curl git unzip \
        build-essential \
        python3 python3-pip python3-venv \
        fsl-core \
        && rm -rf /var/lib/apt/lists/*

    # Set up FSL environment
    echo "export FSLDIR=/usr/share/fsl/6.0" >> /environment
    echo "export PATH=\$FSLDIR/bin:\$PATH" >> /environment
    echo "export FSLOUTPUTTYPE=NIFTI_GZ" >> /environment

    # Install Python dependencies
    python3 -m venv /opt/venv
    . /opt/venv/bin/activate
    pip install --upgrade pip
    pip install bids-validator nipype fslpy numpy pandas
    pip3 install \
        bids-validator \
        nipype \
        niworkflows \
        pandas \
        numpy \
        scikit-learn \
        scipy \
        matplotlib

    # Ensure FSL is properly sourced
    source /environment

    mkdir -p /app

%environment
    export PATH=/opt/venv/bin:$PATH
    export FSLOUTPUTTYPE=NIFTI_GZ
    source /environment

%files
    utils.py /app/utils.py
    workflow.py /app/workflow.py
    run_1st_level.py /app/run_1st_level.py
    get_subjects.py /app/get_subjects.py

%runscript
    exec python3 /app/run_1st_level.py "$@"
